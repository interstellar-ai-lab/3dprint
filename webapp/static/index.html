<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Generation Multi-Agent Web App</title>
    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .input-section {
            grid-column: 1 / -1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            grid-column: 1 / -1;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
        }

        .status-dot.generating {
            background: #ffc107;
        }

        .status-dot.completed {
            background: #28a745;
        }

        .status-dot.error {
            background: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .image-container {
            text-align: center;
            margin: 20px 0;
        }

        .generated-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .image-item {
            text-align: center;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            transition: transform 0.3s ease;
        }

        .image-item:hover {
            transform: scale(1.05);
        }

        .image-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .image-item .view-label {
            margin-top: 8px;
            font-weight: 600;
            color: #667eea;
            font-size: 14px;
        }

        .mesh-container {
            text-align: center;
            margin: 20px 0;
        }

        .mesh-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .iteration-timeline {
            max-height: 600px;
            overflow-y: auto;
        }

        .iteration-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .iteration-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .iteration-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .iteration-title {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .iteration-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .iteration-images {
            margin: 15px 0;
        }

        .iteration-images .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .iteration-images .image-item {
            text-align: center;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .iteration-images .image-item:hover {
            transform: scale(1.05);
        }

        .iteration-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .iteration-image:hover {
            transform: scale(1.05);
        }

        .view-label {
            margin-top: 5px;
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            text-align: center;
        }

        .collapsible {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .collapsible:hover {
            background: #e9ecef;
        }

        .collapsible h4 {
            margin: 0;
            color: #495057;
            font-size: 14px;
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.show {
            max-height: 2000px;
        }

        .iteration-metadata {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
        }

        .iteration-evaluation {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }

        .iteration-evaluation h4 {
            color: #17a2b8;
            margin-bottom: 10px;
        }



        .evaluations {
            margin-top: 20px;
        }

        .evaluation-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .evaluation-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .metadata-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        /* 3D Viewer Styles */
        .viewer-control-btn:hover {
            background: rgba(255, 255, 255, 1) !important;
            transform: scale(1.1);
        }

        .viewer-control-btn.active {
            background: #667eea !important;
            color: white !important;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 3D Generation Multi-Agent</h1>
            <p>Generate high-quality 3D CAD reconstruction materials using AI agents</p>
        </div>

        <div class="main-content">
            <div class="card input-section">
                <h2>🚀 Start Generation</h2>
                <form id="generationForm">
                    <div class="form-group">
                        <label for="query">What would you like to generate?</label>
                        <textarea 
                            id="query" 
                            name="query" 
                            rows="3" 
                            placeholder="e.g., a detailed dog model, a modern chair, a vintage car..."
                            required
                        ></textarea>
                    </div>
                    <button type="submit" class="btn" id="generateBtn">
                        <span class="btn-text">Generate 3D Model</span>
                        <span class="loading-spinner" style="display: none;"></span>
                    </button>
                </form>
            </div>

            <div class="card status-section" id="statusSection" style="display: none;">
                <h2>📊 Generation Status</h2>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Initializing...</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="iterationInfo"></div>
            </div>

            <div class="card" id="imageSection" style="display: none;">
                <h2>🖼️ Generated Images (16 Views)</h2>
                <div class="image-grid" id="imageGrid">
                    <!-- Images will be dynamically added here -->
                </div>
            </div>

            <div class="card" id="meshSection" style="display: none;">
                <h2>🔲 Generated 3D Mesh</h2>
                <div class="mesh-container">
                    <p>Your 3D mesh has been generated and is ready for download.</p>
                    <div class="mesh-info">
                        <span id="meshFilename"></span>
                        <button id="downloadMeshBtn" class="btn btn-secondary">
                            📥 Download Mesh (.obj)
                        </button>
                    </div>
                </div>
                
                <!-- AI-Generated Mesh Visualization -->
                <div class="mesh-visualization-section">
                    <h3>🎨 AI-Generated Mesh Visualization</h3>
                    <div class="mesh-image-container" id="meshImageContainer" style="text-align: center; margin: 20px 0; display: none;">
                        <img id="meshVisualization" style="max-width: 100%; max-height: 500px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);" alt="AI-Generated Mesh Visualization">
                        <p style="margin-top: 10px; color: #666; font-style: italic;">AI-generated 3D mesh visualization from your images</p>
                    </div>
                </div>
                
                <!-- 3D Mesh Viewer -->
                <div class="mesh-viewer-section">
                    <h3>🎮 Interactive 3D Viewer</h3>
                    <div class="viewer-container" id="meshViewerContainer" style="position: relative; width: 100%; height: 500px; border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); margin: 20px 0;">
                        <canvas id="meshCanvas" style="width: 100%; height: 100%; display: block;"></canvas>
                        
                        <div class="viewer-controls" style="position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 10;">
                            <button class="viewer-control-btn" onclick="toggleRotation()" id="rotationBtn" title="Toggle Auto-Rotation" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                                🔄
                            </button>
                            <button class="viewer-control-btn" onclick="resetCamera()" title="Reset Camera" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                                🏠
                            </button>
                            <button class="viewer-control-btn" onclick="toggleWireframe()" id="wireframeBtn" title="Toggle Wireframe" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                                🔲
                            </button>
                            <button class="viewer-control-btn" onclick="screenshot()" title="Take Screenshot" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                                📸
                            </button>
                        </div>
                        
                        <div class="viewer-info" id="viewerInfo" style="position: absolute; bottom: 15px; left: 15px; background: rgba(0, 0, 0, 0.7); color: white; padding: 10px 15px; border-radius: 8px; font-size: 14px; backdrop-filter: blur(10px);">
                            Loading 3D model...
                        </div>
                        
                        <div class="loading-overlay" id="loadingOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; z-index: 20;">
                            <div class="spinner" style="width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px;"></div>
                            Loading 3D model...
                        </div>
                    </div>
                    
                    <div class="viewer-actions" style="display: flex; gap: 15px; margin-top: 20px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="downloadCurrentMesh()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            📥 Download Current Mesh
                        </button>
                        <button class="btn" onclick="exportScreenshot()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            📸 Export Screenshot
                        </button>
                    </div>
                </div>
            </div>

            <div class="card" id="iterationHistorySection" style="display: none;">
                <h2>📊 Iteration History</h2>
                <div class="iteration-timeline" id="iterationTimeline">
                    <!-- Iteration history will be dynamically added here -->
                </div>
            </div>

            <div class="card" id="metadataSection" style="display: none;">
                <h2>📋 Metadata</h2>
                <div class="metadata-display" id="metadataDisplay"></div>
            </div>

            <div class="card" id="evaluationsSection" style="display: none;">
                <h2>📈 Evaluations</h2>
                <div id="evaluationsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let statusCheckInterval = null;

        document.getElementById('generationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const query = document.getElementById('query').value.trim();
            if (!query) return;

            // Show loading state
            const btn = document.getElementById('generateBtn');
            const btnText = btn.querySelector('.btn-text');
            const spinner = btn.querySelector('.loading-spinner');
            
            btn.disabled = true;
            btnText.textContent = 'Starting Generation...';
            spinner.style.display = 'inline-block';

            try {
                // Start generation
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query })
                });

                const result = await response.json();
                
                if (response.ok) {
                    currentSessionId = result.session_id;
                    showStatusSection();
                    startStatusPolling();
                } else {
                    throw new Error(result.detail || 'Failed to start generation');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                // Reset button state
                btn.disabled = false;
                btnText.textContent = 'Generate 3D Model';
                spinner.style.display = 'none';
            }
        });

        function showStatusSection() {
            document.getElementById('statusSection').style.display = 'block';
        }

        function startStatusPolling() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(async () => {
                if (!currentSessionId) return;
                
                try {
                    const response = await fetch(`/api/status/${currentSessionId}`);
                    const status = await response.json();
                    
                    updateStatus(status);
                    
                    if (status.status === 'completed' || status.status === 'error') {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = null;
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 2000);
        }

        function updateStatus(status) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            const progressFill = document.getElementById('progressFill');
            const iterationInfo = document.getElementById('iterationInfo');

            // Update status text and dot
            statusText.textContent = getStatusDisplayText(status.status);
            statusDot.className = `status-dot ${status.status}`;

            // Update progress
            const progress = Math.min((status.iteration / 5) * 100, 100);
            progressFill.style.width = `${progress}%`;

            // Update iteration info
            if (status.iteration > 0) {
                iterationInfo.innerHTML = `
                    <strong>Iteration:</strong> ${status.iteration}/5<br>
                    <strong>Query:</strong> ${status.query}
                `;
            }

            // Show images if available
            if (status.b64_images && status.b64_images.length > 0) {
                showGeneratedImages(status.b64_images, status.mime_types);
            }

            // Show mesh if available
            if (status.mesh_file_path && status.mesh_filename) {
                showGeneratedMesh(status.mesh_filename, currentSessionId);
            }

            // Show iteration history if available
            if (status.iteration_data && Object.keys(status.iteration_data).length > 0) {
                showIterationHistory(status.iteration_data, status.evaluations, status.iteration_meshes, currentSessionId);
            }

            // Show metadata if available
            if (status.metadata) {
                showMetadata(status.metadata);
            }

            // Show evaluations if available
            if (status.evaluations && status.evaluations.length > 0) {
                showEvaluations(status.evaluations);
            }

            // Show error if any
            if (status.error) {
                showError(status.error);
            }
        }

        function getStatusDisplayText(status) {
            const statusMap = {
                'starting': 'Initializing generation...',
                'generating': 'Generating initial model...',
                'evaluating_iteration_1': 'Evaluating iteration 1...',
                'evaluating_iteration_2': 'Evaluating iteration 2...',
                'evaluating_iteration_3': 'Evaluating iteration 3...',
                'evaluating_iteration_4': 'Evaluating iteration 4...',
                'evaluating_iteration_5': 'Evaluating iteration 5...',
                'improving_iteration_1': 'Improving iteration 1...',
                'improving_iteration_2': 'Improving iteration 2...',
                'improving_iteration_3': 'Improving iteration 3...',
                'improving_iteration_4': 'Improving iteration 4...',
                'improving_iteration_5': 'Improving iteration 5...',
                'generating_mesh': 'Generating 3D mesh...',
                'completed': 'Generation completed!',
                'error': 'Error occurred during generation'
            };
            return statusMap[status] || status;
        }

        function showGeneratedImages(b64Images, mimeTypes) {
            const imageSection = document.getElementById('imageSection');
            const imageGrid = document.getElementById('imageGrid');
            
            imageGrid.innerHTML = '';
            
            if (b64Images && b64Images.length > 0) {
                b64Images.forEach((b64Image, index) => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'image-item';
                    
                    const img = document.createElement('img');
                    img.src = `data:${mimeTypes[index] || 'image/png'};base64,${b64Image}`;
                    img.alt = `Generated view ${index + 1}`;
                    
                    const label = document.createElement('div');
                    label.className = 'view-label';
                    label.textContent = `View ${index + 1}`;
                    
                    imageItem.appendChild(img);
                    imageItem.appendChild(label);
                    imageGrid.appendChild(imageItem);
                });
                
                imageSection.style.display = 'block';
            }
        }

        // Three.js Variables
        let scene, camera, renderer, mesh, controls;
        let isRotating = true;
        let isWireframe = false;
        let currentMeshUrl = null;

        function showGeneratedMesh(meshFilename, sessionId) {
            const meshSection = document.getElementById('meshSection');
            const meshFilenameSpan = document.getElementById('meshFilename');
            const downloadMeshBtn = document.getElementById('downloadMeshBtn');
            
            meshFilenameSpan.textContent = `File: ${meshFilename}`;
            
            // Set up download button
            downloadMeshBtn.onclick = () => {
                window.open(`/api/mesh/${sessionId}`, '_blank');
            };
            
            meshSection.style.display = 'block';
            
            // Show mesh visualization first
            showMeshVisualization(sessionId, 0); // Assuming iteration 0 for now
            
            // Initialize and load 3D viewer
            initThreeJS();
            loadOBJModel(`/api/mesh/${sessionId}`);
        }
        
        function showMeshVisualization(sessionId, iteration) {
            const meshImageContainer = document.getElementById('meshImageContainer');
            const meshVisualization = document.getElementById('meshVisualization');
            
            // Try to load the mesh visualization PNG
            const visualizationUrl = `/api/mesh-visualization/${sessionId}/${iteration}`;
            
            meshVisualization.onload = function() {
                meshImageContainer.style.display = 'block';
            };
            
            meshVisualization.onerror = function() {
                console.log('Mesh visualization not available for this iteration');
                meshImageContainer.style.display = 'none';
            };
            
            meshVisualization.src = visualizationUrl;
        }

        // Initialize Three.js Scene
        function initThreeJS() {
            const canvas = document.getElementById('meshCanvas');
            
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight = new THREE.PointLight(0x667eea, 0.5, 100);
            pointLight.position.set(-10, 10, -10);
            scene.add(pointLight);
            
            // Grid Helper
            const gridHelper = new THREE.GridHelper(10, 10, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Animation Loop
            animate();
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (isRotating && mesh) {
                mesh.rotation.y += 0.01;
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        // Load OBJ File
        function loadOBJModel(url) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const viewerInfo = document.getElementById('viewerInfo');
            
            loadingOverlay.style.display = 'flex';
            viewerInfo.textContent = 'Loading 3D model...';
            
            // Clear existing mesh
            if (mesh) {
                scene.remove(mesh);
            }
            
            const loader = new THREE.OBJLoader();
            loader.load(
                url,
                function(object) {
                    // Center and scale the model
                    const box = new THREE.Box3().setFromObject(object);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 3 / maxDim;
                    
                    object.position.sub(center);
                    object.scale.setScalar(scale);
                    
                    // Add material
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0x667eea,
                        shininess: 100,
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    object.traverse(function(child) {
                        if (child.isMesh) {
                            child.material = material;
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    mesh = object;
                    scene.add(mesh);
                    
                    // Update camera to fit model
                    const distance = maxDim * 2;
                    camera.position.set(distance, distance, distance);
                    controls.target.copy(center);
                    controls.update();
                    
                    loadingOverlay.style.display = 'none';
                    viewerInfo.textContent = `Model loaded: ${mesh.children.length} objects`;
                    
                    currentMeshUrl = url;
                },
                function(xhr) {
                    const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
                    viewerInfo.textContent = `Loading: ${progress}%`;
                },
                function(error) {
                    loadingOverlay.style.display = 'none';
                    viewerInfo.textContent = 'Error loading model';
                    console.error('Error loading OBJ:', error);
                }
            );
        }

        // Control Functions
        function toggleRotation() {
            isRotating = !isRotating;
            const btn = document.getElementById('rotationBtn');
            btn.classList.toggle('active', isRotating);
        }

        function resetCamera() {
            if (mesh) {
                const box = new THREE.Box3().setFromObject(mesh);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const distance = maxDim * 2;
                
                camera.position.set(distance, distance, distance);
                controls.target.copy(center);
                controls.update();
            }
        }

        function toggleWireframe() {
            isWireframe = !isWireframe;
            const btn = document.getElementById('wireframeBtn');
            btn.classList.toggle('active', isWireframe);
            
            if (mesh) {
                mesh.traverse(function(child) {
                    if (child.isMesh) {
                        child.material.wireframe = isWireframe;
                    }
                });
            }
        }

        function screenshot() {
            renderer.render(scene, camera);
            const canvas = renderer.domElement;
            const link = document.createElement('a');
            link.download = '3d-model-screenshot.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function downloadCurrentMesh() {
            if (currentMeshUrl) {
                window.open(currentMeshUrl, '_blank');
            }
        }

        function exportScreenshot() {
            screenshot();
        }

        function showIterationHistory(iterationData, evaluations, iterationMeshes, sessionId) {
            const historySection = document.getElementById('iterationHistorySection');
            const timeline = document.getElementById('iterationTimeline');
            
            timeline.innerHTML = '';
            
            // Sort iterations by number
            const iterations = Object.keys(iterationData).sort((a, b) => parseInt(a) - parseInt(b));
            
            iterations.forEach(iteration => {
                const data = iterationData[iteration];
                const evaluation = evaluations.find(e => e.iteration == iteration);
                const hasMesh = iterationMeshes && iterationMeshes[iteration];
                
                const iterationItem = document.createElement('div');
                iterationItem.className = 'iteration-item';
                
                iterationItem.innerHTML = `
                    <div class="iteration-header">
                        <div class="iteration-title">Iteration ${iteration}</div>
                        <div class="iteration-actions">
                            ${hasMesh ? `<button class="btn btn-secondary btn-small" onclick="downloadIterationMesh('${sessionId}', ${iteration})">
                                📥 Download Mesh
                            </button>` : ''}
                            ${hasMesh ? `<button class="btn btn-small" onclick="showIterationMeshVisualization('${sessionId}', ${iteration})">
                                🎨 View Mesh
                            </button>` : ''}
                            <button class="btn btn-small" onclick="toggleIterationDetails(${iteration})">
                                📋 Toggle Details
                            </button>
                        </div>
                    </div>
                    
                    <div class="collapsible-content" id="iteration-${iteration}-content">
                        <div class="collapsible" onclick="toggleCollapsible('images-${iteration}')">
                            <h4>🖼️ Generated Images (${data.b64_images.length} views)</h4>
                        </div>
                        <div class="iteration-images collapsible-content" id="images-${iteration}">
                            <div class="image-grid">
                                ${data.b64_images.map((img, index) => `
                                    <div class="image-item">
                                        <img src="data:${data.mime_types[index] || 'image/png'};base64,${img}" 
                                             alt="View ${index + 1}" 
                                             class="iteration-image"
                                             onclick="showImageModal('data:${data.mime_types[index] || 'image/png'};base64,${img}', 'Iteration ${iteration} - View ${index + 1}')">
                                        <div class="view-label">View ${index + 1}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="collapsible" onclick="toggleCollapsible('metadata-${iteration}')">
                            <h4>📄 Metadata</h4>
                        </div>
                        <div class="iteration-metadata collapsible-content" id="metadata-${iteration}">
                            ${data.metadata}
                        </div>
                        
                        ${evaluation ? `
                            <div class="iteration-evaluation">
                                <h4>📊 Evaluation</h4>
                                <div><strong>Summary:</strong> ${evaluation.short_summary}</div>
                                <div><strong>Suggestions:</strong> ${evaluation.suggestions}</div>
                                <div class="collapsible" onclick="toggleCollapsible('report-${iteration}')">
                                    <strong>📋 Full Report</strong>
                                </div>
                                <div class="collapsible-content" id="report-${iteration}">
                                    ${evaluation.markdown_report}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                timeline.appendChild(iterationItem);
            });
            
            historySection.style.display = 'block';
        }

        function downloadIterationMesh(sessionId, iteration) {
            window.open(`/api/mesh/${sessionId}/${iteration}`, '_blank');
        }
        
        function showIterationMeshVisualization(sessionId, iteration) {
            // Create modal for mesh visualization
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                cursor: pointer;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                background: white;
                border-radius: 12px;
                padding: 20px;
                text-align: center;
                cursor: default;
            `;
            
            const title = document.createElement('h3');
            title.textContent = `AI-Generated Mesh Visualization - Iteration ${iteration}`;
            title.style.marginBottom = '20px';
            
            const img = document.createElement('img');
            img.style.cssText = `
                max-width: 100%;
                max-height: 70vh;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            `;
            img.alt = `Mesh Visualization - Iteration ${iteration}`;
            
            const visualizationUrl = `/api/mesh-visualization/${sessionId}/${iteration}`;
            
            img.onload = function() {
                modalContent.appendChild(title);
                modalContent.appendChild(img);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            };
            
            img.onerror = function() {
                const errorMsg = document.createElement('p');
                errorMsg.textContent = 'Mesh visualization not available for this iteration';
                errorMsg.style.color = '#666';
                modalContent.appendChild(title);
                modalContent.appendChild(errorMsg);
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            };
            
            img.src = visualizationUrl;
            
            // Close modal on click
            modal.onclick = function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        function toggleIterationDetails(iteration) {
            const content = document.getElementById(`iteration-${iteration}-content`);
            content.classList.toggle('show');
        }

        function toggleCollapsible(elementId) {
            const content = document.getElementById(elementId);
            content.classList.toggle('show');
        }

        function showImageModal(imageSrc, title) {
            // Create modal for full-size image viewing
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
                border-radius: 8px;
            `;
            
            const titleDiv = document.createElement('div');
            titleDiv.textContent = title;
            titleDiv.style.cssText = `
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                color: white;
                font-size: 18px;
                font-weight: bold;
            `;
            
            modal.appendChild(titleDiv);
            modal.appendChild(img);
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }

        function showMetadata(metadata) {
            const metadataSection = document.getElementById('metadataSection');
            const metadataDisplay = document.getElementById('metadataDisplay');
            
            metadataDisplay.textContent = metadata;
            metadataSection.style.display = 'block';
        }

        function showEvaluations(evaluations) {
            const evaluationsSection = document.getElementById('evaluationsSection');
            const container = document.getElementById('evaluationsContainer');
            
            container.innerHTML = evaluations.map(eval => `
                <div class="evaluation-item">
                    <h4>Iteration ${eval.iteration}</h4>
                    <p><strong>Summary:</strong> ${eval.short_summary}</p>
                    <p><strong>Suggestions:</strong> ${eval.suggestions}</p>
                    <details>
                        <summary>View Full Report</summary>
                        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                            ${eval.markdown_report.replace(/\n/g, '<br>')}
                        </div>
                    </details>
                </div>
            `).join('');
            
            evaluationsSection.style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = `Error: ${message}`;
            
            const container = document.querySelector('.container');
            container.appendChild(errorDiv);
            
            // Remove error after 5 seconds
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Handle window resize for Three.js canvas
        window.addEventListener('resize', function() {
            if (camera && renderer) {
                const canvas = document.getElementById('meshCanvas');
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            }
        });
    </script>
</body>
</html> 